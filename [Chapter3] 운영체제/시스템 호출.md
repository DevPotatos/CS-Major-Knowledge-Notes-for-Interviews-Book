## 시스템 호출
> 시스템 호출은 운영체제의 커널이 제공하는 서비스에 대해, 응용프로그램의 요청에 따라 커널에 접근하기 위한 인터페이스이다.

``` 
1) 사용자 공간의 코드에서 커널 서비스를 요청하는 과정으로, 커널 콜(kernel call), 트랩(trap) 으로 불림
2) 운영체제가 시스템 호출 라이브러리 제공
3) 시스템 호출을 일으키는 기계명령 : Int 0x80, syscall/sysret, sysenter/sysexit 등
4) 시스템 호출은 라이브러리를 통해 간접적으로 이루어진다.
```

&nbsp;**커널(kernel)** 은 운영체제의 핵심 부분이자 시스템 호출 인터페이스를 제공하며 보안, 메모리, 프로세스, 파일 시스템, I/O 디바이스, I/O 요청 관리 등 운영체제의 중요한 역할을 담당한다. 응용 프로그램은 자원의 충돌과 훼손의 위험이 있다는 이유로 컴퓨터 자원에 대한 직접적인 접근이 금지되며, 컴퓨터 자원에 대한 모든 접근은 운영체제(커널)만이 가능하다. 시스템 호출은 이러한 커널의 기능을 응용프로그램이 사용할 수 있도록 제공되는 인터페이스이다.


<br>

### 사용자 모드와 커널 모드
&nbsp;운영체제는 사용자 모드와 커널 모드로 나뉘어 구동된다. 사용자 모드와 커널 모드는 CPU 내부에 모드 상태를 나타내는 모드 레지스터의 값으로 구별되며, 사용자 모드에서 커널 모드로 전환되는 경우는 `시스템 호출이 발생` 하거나 `인터럽트가 발생` 하였을 경우이다.


#### 사용자 모드
- cpu의 모드 비트 = 1
- cpu가 사용자 공간의 코드나 데이터를 엑세스 하는 것을 나타냄
- 커널 공간 접근 불허
- 특권 명령 실행 불허


#### 커널 모드
- cpu의 모드 비트 = 0
- cpu가 커널 공간에서 실행 혹은 사용자 코드를 실행하는 것을 나타냄
- 시스템 호출을 하게 되면 커널 모드로 전환
- cpu가 인터럽트를 수신할 경우, 커널 모드로 자동 전환

<br>

### 시스템 호출 라이브러리
> 시스템 호출을 진행하여 커널 모드로 바꾸고, 커널로 진입하여 커널의 다양한 기능을 수행하는 라이브러리이다.

&nbsp;시스템 호출 라이브러리는 운영체제에 의존적이다. 응용 프로그램이 커널의 기능을 사용하고자 할 때, 시스템 호출 라이브러리에 포함된 시스템 호출 함수를 통해 시스템 호출을 발생시킨다. <br><br>
&nbsp;커널에 있는 함수들은 이름이 없고 id 번호로 구분이 되는데, 시스템 호출 함수는 cpu의 특정 레지스터에 이 **시스템 호출 번호(커널 함수 id)** 와 **매개변수**를 저장하고 시스템 호출을 일으키는 **기계 명령**(ex: syscall)을 수행한다.

<br>

### 프로세스 관련 시스템 호출 함수
> 프로세스 관련 시스템 호출은 `fork()` , `exec()` , `wait()` , `exit()` 이 있다.
- **fork()** 는 부모 프로세스를 자식 프로세스로 복제 시키는 것으로, 이때 자식은 부모의 context를 그대로 복사하여 가져온다.
- **exec()** 는 fork()로 복제된 자식 프로세스에 새로운 프로그램을 덮어 씌우는 것으로, 자식 프로세스가 독자적인 작업을 수행할 수 있도록 한다.
- **wait()** 는 부모 프로세스가 자식 프로세스가 종료 되기를 기다리는 것이다.
- **exit()** 은 프로그램을 종료시키는 함수이다. 해당 프로세스가 가지고 있던 모든 자원을 반납하고 부모 프로세스에게 자신이 종료됨을 알린다. 


<br>

### 시스템 호출 과정

&nbsp;시스템 호출 과정은 다음과 같다.

1. 시스템 호출 함수가 cpu의 특정 레지스터들에 `시스템 호출 번호`와 `매개변수` 저장
2. 시스템 호출을 일으키는 특별한 `기계 명령(syscall, Int 0x80)`을 실행
3. **커널 모드**로 변경되어 `시스템 호출 핸들러`가 실행됨
4. 시스템 호출 핸들러는 현재 cpu 레지스터들을 응용 프로그램이 할당 받은 커널 스택에 저장한 후, cpu의 레지스터를 읽어 **시스템 호출 번호**를 알아냄
5. 시스템 호출 표에서 커널 함수의 주소를 알아내고, 커널 함수 호출
6. 커널 함수가 수행됨
7. 커널 함수로부터 리턴하고, 커널 스택에 저장해둔 레지스터 값을 cpu로 복귀시킴
8. 시스템 호출을 끝내는 기계 명령이 실행되고, 사용자 모드로 변환됨

<br>

&nbsp;시스템 호출은 이와 같이 함수 표준 라이브러리의 함수 호출에 비해 많은 시간 비용이 들기 때문에 시스템 호출을 많이 할수록, 프로그램의 실행속도가 저하된다. 따라서, 시스템 호출은 필수적이지만 그 횟수를 줄여야 응용프로그램의 실행시간이 짧아지고, 시스템 입장에서 더 많은 프로그램을 실행시킬 수 있는 시간을 확보할 수 있다.

